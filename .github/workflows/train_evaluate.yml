name: train_evaluate

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write # ‚¨ÖÔ∏è –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è CML, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  pull-requests: write

jobs:
  train-report-more:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
        
      - name: Python-setup
        uses: actions/setup-python@v6.0.0
        with:
          python-version: 3.11

      - name: Dependencies
        run: pip install -r requirements.txt

      - name: DVC Setup
        uses: iterative/setup-dvc@v1
        
      # === –ö–†–û–ö 1: –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø CML ===
      - name: Setup Node
        uses: actions/setup-node@v4 # ‚¨ÖÔ∏è –ü–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è CML
        with:
          node-version: '20' 

      - name: Install CML CLI
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ CML —á–µ—Ä–µ–∑ NPM (—Ü–µ –Ω–∞–π–Ω–∞–¥—ñ–π–Ω—ñ—à–∏–π —Å–ø–æ—Å—ñ–±)
        run: npm install -g cml
      # =================================

      - name: DVC Run
        run: dvc repro # –¢—É—Ç –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è metrics.json —Ç–∞ predictions.csv

      - name: Write report and create plot
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–≤—ñ—Ç—É Markdown
          echo "## üìä ML-–ü–∞–π–ø–ª–∞–π–Ω –ó–≤—ñ—Ç" > report.md
          dvc metrics show --md >> report.md
          
          git fetch --prune
          dvc metrics diff --md main >> report.md

          # 2. –ì–ï–ù–ï–†–£–Ñ–ú–û –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø –ú–ê–¢–†–ò–¶–Ü –ü–õ–£–¢–ê–ù–ò–ù–ò (SVG)
          # DVC –≥–µ–Ω–µ—Ä—É—î SVG –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó 'plots' —É dvc.yaml
          dvc plots show --title "Confusion Matrix" --target predictions.csv -o confusion_matrix.svg
          
          # 3. –î–û–î–ê–Ñ–ú–û –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø –î–û –ó–í–Ü–¢–£
          # CML-–∫–æ–º–∞–Ω–¥–∞ 'cml pr write' –º–æ–∂–µ –ø—Ä–∏–π–º–∞—Ç–∏ —Ç–µ–∫—Å—Ç —Ç–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          echo "### –ú–∞—Ç—Ä–∏—Ü—è –ü–ª—É—Ç–∞–Ω–∏–Ω–∏" >> report.md
          echo "![](./confusion_matrix.svg)" >> report.md # –ü–æ—Å–∏–ª–∞—î–º–æ—Å—è –Ω–∞ SVG-—Ñ–∞–π–ª
          
          # 4. –ü–£–ë–õ–Ü–ö–£–Ñ–ú–û –ó–í–Ü–¢ –¢–ê –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø –ß–ï–†–ï–ó CML
          # CML –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –ª–æ–∫–∞–ª—å–Ω—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (SVG/PNG) –Ω–∞ GitHub —ñ –≤—Å—Ç–∞–≤–ª—è—î —ó—Ö —É –∫–æ–º–µ–Ω—Ç–∞—Ä.
          cml pr write report.md
